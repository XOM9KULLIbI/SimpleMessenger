# Реализация поддержки видео с превью и загрузкой

## Обзор изменений

Была добавлена полноценная поддержка отправки, просмотра и загрузки видеофайлов с превью, аналогично реализации для фотографий.

## Основные изменения

### 1. Обновление layout видео сообщений (`item_message_video.xml`)

**Изменения:**
- Заменён `VideoView` на `ImageView` для отображения превью видео
- Добавлена иконка воспроизведения поверх превью
- Добавлен индикатор загрузки
- Обновлена структура для корректного отображения статуса прочтения

**Ключевые элементы:**
```xml
<ImageView android:id="@+id/videoThumbnail" />     <!-- Превью видео -->
<ProgressBar android:id="@+id/loadingIndicator" />  <!-- Индикатор загрузки -->
<ImageView android:id="@+id/playIcon" />           <!-- Иконка play -->
<ImageButton android:id="@+id/downloadVideoButton" /> <!-- Кнопка скачивания -->
```

### 2. Обновление VideoViewHolder в MessageAdapter

**Новая функциональность:**
- Загрузка превью видео через Glide
- Индикатор загрузки с автоматическим скрытием
- Использование placeholder'а при ошибках загрузки
- Клик по превью для открытия в полноэкранном режиме

**Ключевые особенности:**
```kotlin
// Простая загрузка превью с индикатором загрузки
Glide.with(context)
    .load(fullUrl)
    .placeholder(R.drawable.video_placeholder)
    .error(R.drawable.video_placeholder)
    .into(videoThumbnail)

// Показ иконки play после загрузки
videoThumbnail.postDelayed({
    loadingIndicator.visibility = View.GONE
    playIcon.visibility = View.VISIBLE
}, 500)
```

### 3. Улучшение полноэкранного просмотра видео

**Обновления в FullscreenMediaActivity:**
- Добавлены элементы управления MediaController
- Улучшена обработка ошибок воспроизведения
- Лучшее позиционирование и фокус

### 4. Улучшение MediaDownloadHelper

**Новые возможности:**
- Сортировка файлов по типам (видео → MOVIES, изображения → PICTURES)
- Создание папки SimpleMessenger для организации загрузок
- Генерация уникальных имён файлов с timestamps
- Улучшенная обработка ошибок
- Поддержка различных типов сетей

### 5. Drawable ресурсы

**Новые файлы:**
- `play_button_bg.xml` - фон для кнопки воспроизведения
- `video_placeholder.xml` - placeholder для видео при ошибках загрузки

### 6. Обновление разрешений в AndroidManifest

**Добавленные разрешения:**
```xml
<!-- Разрешения для загрузки медиафайлов -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
    android:maxSdkVersion="28" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" 
    android:maxSdkVersion="32" />
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
<uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
```

## Как это работает

### Отправка видео
1. Пользователь нажимает кнопку прикрепления
2. Выбирает видеофайл через системный селектор
3. Файл отправляется на сервер через multipart/form-data
4. Сервер определяет тип файла и возвращает URL

### Отображение в чате
1. При получении сообщения с типом "video" создается VideoViewHolder
2. Glide загружает превью видео по URL
3. Показывается индикатор загрузки, затем превью с иконкой play
4. При ошибках загрузки показывается placeholder

### Полноэкранный просмотр
1. Клик по превью открывает FullscreenMediaActivity
2. Видео загружается в VideoView с MediaController
3. Пользователь может управлять воспроизведением
4. Доступна кнопка загрузки

### Загрузка
1. Клик по кнопке загрузки запускает DownloadManager
2. Файл сохраняется в соответствующую папку (Movies для видео)
3. Показывается уведомление о прогрессе и завершении

## Технические особенности

### Производительность
- Используется ImageView вместо VideoView в списке для лучшей производительности
- Glide эффективно кэширует превью
- Lazy loading превью только при необходимости

### UX/UI
- Индикатор загрузки для превью
- Иконка play для понимания, что это видео
- Статус прочтения как в текстовых сообщениях
- Consistent дизайн с фото сообщениями

### Обработка ошибок
- Placeholder при ошибках загрузки превью
- Toast уведомления об ошибках
- Graceful fallback при проблемах с сетью

## Совместимость

- Минимальная версия Android: API 21 (Android 5.0)
- Целевая версия: API 36
- Поддержка различных форматов видео (определяется сервером)
- Адаптивные разрешения для разных версий Android

## Зависимости

Все необходимые зависимости уже присутствуют в проекте:
- Glide 4.16.0 для загрузки изображений
- OkHttp 4.12.0 для сетевых запросов
- Material Components для UI
- Android support libraries

## Серверная поддержка

Сервер уже поддерживает:
- Endpoint `/send_media` для загрузки файлов
- Автоматическое определение типа файла (image/video)
- Раздача медиафайлов через `/media/<filename>`
- Корректное формирование URL для клиента